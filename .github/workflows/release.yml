name: Release

on:
  push:
    tags:
      - "v*"
      - "[0-9]+.[0-9]+.[0-9]+*"
  workflow_dispatch:
    inputs:
      skip_release:
        description: 'Build only (skip creating GitHub release)'
        type: boolean
        default: true

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            archive: tar.gz

    runs-on: ${{ matrix.os }}
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-${{ matrix.target }}

      - name: Import Apple certificate
        if: runner.os == 'macOS'
        env:
          CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          set -euo pipefail

          # Skip if no certificate configured
          if [ -z "${CERTIFICATE:-}" ]; then
            echo "::warning::No APPLE_CERTIFICATE secret configured, skipping code signing"
            echo "SIGNING_ENABLED=false" >> $GITHUB_ENV
            exit 0
          fi

          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          CERT_PATH=$RUNNER_TEMP/certificate.p12

          # Create and configure keychain
          echo "Creating temporary keychain..."
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 900 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "Importing certificate..."
          echo "$CERTIFICATE" | base64 --decode > "$CERT_PATH"

          if ! security import "$CERT_PATH" \
            -P "$CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"; then
            echo "::error::Failed to import certificate"
            rm -f "$CERT_PATH"
            exit 1
          fi

          # Immediately delete the certificate file
          rm -f "$CERT_PATH"

          # Configure for codesign
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Verify certificate is available
          echo "Available signing identities:"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

          # Export for subsequent steps
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "SIGNING_ENABLED=true" >> $GITHUB_ENV

      - name: Build release binary
        run: cargo build --release --locked --target ${{ matrix.target }}

      - name: Build Swift OCR helper
        if: runner.os == 'macOS'
        run: |
          cd swift/catboard-ocr
          swift build -c release
          cp .build/release/catboard-ocr ../../target/${{ matrix.target }}/release/

      - name: Sign macOS binaries
        if: runner.os == 'macOS' && env.SIGNING_ENABLED == 'true'
        env:
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
        run: |
          set -euo pipefail

          echo "Keychain path: $KEYCHAIN_PATH"

          # List all available identities for debugging
          echo "=== All available signing identities ==="
          security find-identity -v -p codesigning "$KEYCHAIN_PATH" || true

          # Find signing identity
          IDENTITY=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | \
            grep "Developer ID Application" | head -1 | awk -F '"' '{print $2}')

          if [ -z "$IDENTITY" ]; then
            echo "::error::No Developer ID Application certificate found"
            echo "Make sure you exported a 'Developer ID Application' certificate, not an Apple Development or other type."
            exit 1
          fi

          echo "Using identity: $IDENTITY"

          # Sign binaries with retry for timestamp server failures
          BINARY_PATH="target/${{ matrix.target }}/release/catboard"
          OCR_HELPER_PATH="target/${{ matrix.target }}/release/catboard-ocr"

          for BINARY in "$BINARY_PATH" "$OCR_HELPER_PATH"; do
            ATTEMPT=1
            MAX_ATTEMPTS=3
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo "Signing $BINARY (attempt $ATTEMPT of $MAX_ATTEMPTS)..."
              if codesign --force --deep --options runtime \
                --sign "$IDENTITY" \
                --timestamp \
                "$BINARY"; then
                echo "Signing succeeded: $BINARY"
                break
              else
                if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                  echo "::error::Signing failed after $MAX_ATTEMPTS attempts: $BINARY"
                  exit 1
                fi
                echo "Retry in 5 seconds..."
                sleep 5
                ATTEMPT=$((ATTEMPT + 1))
              fi
            done
          done

          # Sign Quick Action workflow
          echo "Signing Quick Action workflow..."
          codesign --force --deep \
            --sign "$IDENTITY" \
            --timestamp \
            "macos/Copy to Clipboard.workflow"

          # Verify signatures
          echo "=== Verifying catboard signature ==="
          codesign --verify --deep --strict --verbose=4 "$BINARY_PATH"

          echo "=== Verifying catboard-ocr signature ==="
          codesign --verify --deep --strict --verbose=4 "$OCR_HELPER_PATH"

          echo "=== Verifying Quick Action signature ==="
          codesign --verify --deep --strict --verbose=4 "macos/Copy to Clipboard.workflow"

          # Display signature info
          echo "=== catboard signature details ==="
          codesign --display --verbose=4 "$BINARY_PATH"

          echo "=== catboard-ocr signature details ==="
          codesign --display --verbose=4 "$OCR_HELPER_PATH"

          # Test Gatekeeper (may fail without notarization)
          echo "=== Gatekeeper assessment ==="
          spctl --assess --type execute --verbose=4 "$BINARY_PATH" || \
            echo "::warning::Gatekeeper check failed (notarization may be required for full compliance)"

      - name: Notarize macOS binary
        if: runner.os == 'macOS' && env.SIGNING_ENABLED == 'true'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail

          # Skip if notarization credentials not configured
          if [ -z "${APPLE_ID:-}" ] || [ -z "${APPLE_ID_PASSWORD:-}" ]; then
            echo "::notice::Notarization skipped - APPLE_ID or APPLE_ID_PASSWORD not configured"
            exit 0
          fi

          BINARY_PATH="target/${{ matrix.target }}/release/catboard"
          OCR_HELPER_PATH="target/${{ matrix.target }}/release/catboard-ocr"

          # Create ZIP for notarization (include both binaries)
          echo "Creating ZIP for notarization..."
          mkdir -p notarize-tmp
          cp "$BINARY_PATH" "$OCR_HELPER_PATH" notarize-tmp/
          ditto -c -k notarize-tmp catboard-binaries.zip

          # Submit and wait
          echo "Submitting for notarization..."
          xcrun notarytool submit catboard-binaries.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$TEAM_ID" \
            --wait \
            --timeout 30m

          # Staple (optional for CLI binaries, may not be supported)
          echo "Attempting to staple..."
          xcrun stapler staple "$BINARY_PATH" || \
            echo "::notice::Stapling not supported for CLI binaries (this is normal)"
          xcrun stapler staple "$OCR_HELPER_PATH" || \
            echo "::notice::Stapling not supported for CLI binaries (this is normal)"

          rm -rf notarize-tmp catboard-binaries.zip

          # Note: We skip the final spctl verification because:
          # 1. CLI binaries can't be stapled (only .app bundles)
          # 2. Without stapling, spctl will always report "Unnotarized Developer ID"
          # 3. The notarization WAS accepted by Apple (see above)
          # 4. Gatekeeper will verify the notarization online when users run the binary
          echo "::notice::Notarization complete. Binary will pass Gatekeeper (verified online)."

      - name: Package tarball
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="dev-${GITHUB_SHA::7}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

          ARCHIVE_NAME="catboard-${VERSION}-${{ matrix.target }}"
          mkdir -p "${ARCHIVE_NAME}"
          cp "target/${{ matrix.target }}/release/catboard" "${ARCHIVE_NAME}/"
          cp "target/${{ matrix.target }}/release/catboard-ocr" "${ARCHIVE_NAME}/"
          cp -r "macos/Copy to Clipboard.workflow" "${ARCHIVE_NAME}/"
          cp README.md LICENSE "${ARCHIVE_NAME}/"

          # Create install instructions
          {
            echo "# macOS Installation"
            echo ""
            echo "## Quick Install"
            echo ""
            echo "    sudo cp catboard catboard-ocr /usr/local/bin/"
            echo "    cp -r \"Copy to Clipboard.workflow\" ~/Library/Services/"
            echo ""
            echo "## What's Included"
            echo ""
            echo "- **catboard** - Main CLI tool for copying file contents to clipboard"
            echo "- **catboard-ocr** - OCR helper using macOS Vision framework (for images and scanned PDFs)"
            echo "- **Copy to Clipboard.workflow** - Finder Quick Action for right-click integration"
            echo ""
            echo "## Features"
            echo ""
            echo "- Copy text files to clipboard"
            echo "- Extract text from PDFs"
            echo "- OCR images (PNG, JPG, TIFF, etc.) using macOS Vision"
            echo "- OCR scanned PDFs automatically"
            echo ""
            echo "## Usage"
            echo ""
            echo "    catboard file.txt        # Copy text file"
            echo "    catboard document.pdf    # Extract PDF text"
            echo "    catboard screenshot.png  # OCR image (requires catboard-ocr)"
          } > "${ARCHIVE_NAME}/INSTALL_MACOS.md"

          tar czf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}.tar.gz" >> $GITHUB_ENV

      - name: Build macOS installer (.pkg)
        if: runner.os == 'macOS'
        env:
          SIGNING_ENABLED: ${{ env.SIGNING_ENABLED }}
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
        run: |
          set -euo pipefail
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present

          # Create directory structure for pkg
          PKG_ROOT=$(mktemp -d)
          mkdir -p "${PKG_ROOT}/usr/local/bin"
          mkdir -p "${PKG_ROOT}/Library/Services"

          # Copy binaries
          cp "target/${{ matrix.target }}/release/catboard" "${PKG_ROOT}/usr/local/bin/"
          cp "target/${{ matrix.target }}/release/catboard-ocr" "${PKG_ROOT}/usr/local/bin/"

          # Copy Quick Action workflow
          cp -r "macos/Copy to Clipboard.workflow" "${PKG_ROOT}/Library/Services/"

          # Create postinstall script to copy workflow to user's Services folder
          SCRIPTS_DIR=$(mktemp -d)
          cat > "${SCRIPTS_DIR}/postinstall" << 'POSTINSTALL'
          #!/bin/bash
          # Copy workflow to current user's Services folder
          CURRENT_USER="${USER:-$(logname 2>/dev/null || echo '')}"
          if [ -n "$CURRENT_USER" ] && [ "$CURRENT_USER" != "root" ]; then
            USER_HOME=$(eval echo "~$CURRENT_USER")
            USER_SERVICES="${USER_HOME}/Library/Services"
            mkdir -p "$USER_SERVICES"
            cp -r "/Library/Services/Copy to Clipboard.workflow" "$USER_SERVICES/" 2>/dev/null || true
            chown -R "$CURRENT_USER" "$USER_SERVICES/Copy to Clipboard.workflow" 2>/dev/null || true
          fi
          exit 0
          POSTINSTALL
          chmod +x "${SCRIPTS_DIR}/postinstall"

          # Build component package
          pkgbuild \
            --root "${PKG_ROOT}" \
            --scripts "${SCRIPTS_DIR}" \
            --identifier "com.verilypete.catboard" \
            --version "${VERSION}" \
            --install-location "/" \
            "catboard-component.pkg"

          # Create distribution XML
          cat > distribution.xml << DIST
          <?xml version="1.0" encoding="utf-8"?>
          <installer-gui-script minSpecVersion="2">
              <title>Catboard</title>
              <organization>com.verilypete</organization>
              <domains enable_localSystem="true"/>
              <options customize="never" require-scripts="true" rootVolumeOnly="true"/>
              <welcome file="welcome.txt"/>
              <conclusion file="conclusion.txt"/>
              <pkg-ref id="com.verilypete.catboard"/>
              <choices-outline>
                  <line choice="default">
                      <line choice="com.verilypete.catboard"/>
                  </line>
              </choices-outline>
              <choice id="default"/>
              <choice id="com.verilypete.catboard" visible="false">
                  <pkg-ref id="com.verilypete.catboard"/>
              </choice>
              <pkg-ref id="com.verilypete.catboard" version="${VERSION}">catboard-component.pkg</pkg-ref>
          </installer-gui-script>
          DIST

          # Create resources
          RESOURCES_DIR=$(mktemp -d)
          cat > "${RESOURCES_DIR}/welcome.txt" << 'WELCOME'
          Welcome to Catboard!

          This installer will install:
          • catboard - CLI tool for copying file contents to clipboard
          • catboard-ocr - OCR helper for images and scanned PDFs
          • Copy to Clipboard - Finder Quick Action

          Features:
          • Copy text files to clipboard
          • Extract text from PDF documents
          • OCR images and scanned PDFs using macOS Vision
          WELCOME

          cat > "${RESOURCES_DIR}/conclusion.txt" << 'CONCLUSION'
          Catboard has been installed successfully!

          Usage:
            catboard file.txt        # Copy text file
            catboard document.pdf    # Extract PDF text
            catboard screenshot.png  # OCR image

          The "Copy to Clipboard" Quick Action is now available.
          Right-click any file in Finder to use it.
          CONCLUSION

          # Build product archive
          PKG_NAME="catboard-${VERSION}-installer.pkg"
          productbuild \
            --distribution distribution.xml \
            --resources "${RESOURCES_DIR}" \
            --package-path . \
            "${PKG_NAME}"

          # Sign the installer if signing is enabled
          if [ "${SIGNING_ENABLED:-false}" = "true" ]; then
            echo "Signing installer package..."
            INSTALLER_IDENTITY=$(security find-identity -v -p basic "${KEYCHAIN_PATH}" | \
              grep "Developer ID Installer" | head -1 | awk -F '"' '{print $2}')

            if [ -n "$INSTALLER_IDENTITY" ]; then
              productsign --sign "$INSTALLER_IDENTITY" "${PKG_NAME}" "${PKG_NAME}.signed"
              mv "${PKG_NAME}.signed" "${PKG_NAME}"
              echo "Installer signed successfully"
            else
              echo "::warning::No Developer ID Installer certificate found, package unsigned"
            fi
          fi

          echo "PKG_NAME=${PKG_NAME}" >> $GITHUB_ENV

          # Cleanup
          rm -rf "${PKG_ROOT}" "${SCRIPTS_DIR}" "${RESOURCES_DIR}"
          rm -f catboard-component.pkg distribution.xml

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v6
        with:
          name: catboard-${{ matrix.target }}
          path: ${{ env.ARCHIVE_NAME }}
          retention-days: 1

      - name: Upload pkg artifact
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v6
        with:
          name: catboard-installer
          path: ${{ env.PKG_NAME }}
          retention-days: 1

      - name: Clean up keychain
        if: runner.os == 'macOS' && always()
        run: |
          KEYCHAIN_PATH="${KEYCHAIN_PATH:-$RUNNER_TEMP/signing.keychain-db}"

          # Delete keychain if it exists
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || \
              echo "::warning::Failed to delete keychain"
          fi

          # Clean up any leftover certificate files
          rm -f $RUNNER_TEMP/certificate.p12 2>/dev/null || true

          # Reset to default keychain
          security list-keychains -d user -s login.keychain 2>/dev/null || true

  release:
    name: Create Release
    needs: build
    if: ${{ !inputs.skip_release }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.pkg" \) -exec mv {} release/ \;
          cd release
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') || contains(github.ref, 'rc') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew tap
        if: ${{ !contains(github.ref, 'beta') && !contains(github.ref, 'alpha') && !contains(github.ref, 'rc') }}
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          set -euo pipefail

          # Skip if no token configured
          if [ -z "${HOMEBREW_TAP_TOKEN:-}" ]; then
            echo "::notice::HOMEBREW_TAP_TOKEN not configured, skipping tap update"
            exit 0
          fi

          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION_NUM=${VERSION#v}  # Remove 'v' prefix

          # Calculate SHA256 of the tarball
          TARBALL="release/catboard-${VERSION}-aarch64-apple-darwin.tar.gz"
          if [ ! -f "$TARBALL" ]; then
            echo "::error::Tarball not found: $TARBALL"
            exit 1
          fi
          SHA256=$(sha256sum "$TARBALL" | cut -d' ' -f1)

          echo "Version: $VERSION_NUM"
          echo "SHA256: $SHA256"

          # Clone the tap repo
          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/VerilyPete/homebrew-catboard.git" tap-repo
          cd tap-repo

          # Create/update the formula
          mkdir -p Formula
          cat > Formula/catboard.rb << FORMULA
          class Catboard < Formula
            desc "Copy file contents to clipboard with PDF text extraction and OCR"
            homepage "https://github.com/VerilyPete/catboard"
            version "${VERSION_NUM}"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/VerilyPete/catboard/releases/download/${VERSION}/catboard-${VERSION}-aarch64-apple-darwin.tar.gz"
                sha256 "${SHA256}"
              end
            end

            def install
              bin.install "catboard"
              bin.install "catboard-ocr"
              pkgshare.install "Copy to Clipboard.workflow"
            end

            def caveats
              <<~EOS
                To enable Finder right-click integration, run:
                  cp -r "#{pkgshare}/Copy to Clipboard.workflow" ~/Library/Services/

                Then right-click any file in Finder to see "Copy to Clipboard" under Quick Actions.
              EOS
            end

            test do
              assert_match "catboard", shell_output("#{bin}/catboard --version")
            end
          end
          FORMULA

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/catboard.rb
          git commit -m "Update catboard to ${VERSION}"
          git push

          echo "::notice::Homebrew tap updated successfully"
